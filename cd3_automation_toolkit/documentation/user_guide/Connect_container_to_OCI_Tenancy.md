# Connect Docker container to OCI Tenancy


> ***Same container can be connected to multiple OCI tenancies. Repeat this process for every new OCI tenancy.***

### **Step 1 - Exec into the Container**:
* Run  ```docker ps```.
<br> → Note down the container ID from this cmd output.
* Run  ```docker exec -it <container_id> bash```
<br>Change Directory to 'user-scripts'
<br>```cd /cd3user/oci_tools/cd3_automation_toolkit/user-scripts/```

### **Step 2 - Create API PEM Key**:
<br>If the key pair does not exist, create them using the below command:
<br>```python createAPIKey.py```
<br> → This will generate the public/private key pair (***_oci_api_public.pem_*** and ***_oci_api_private.pem_***) at **_/cd3user/tenancies/keys/_**
<br> → In case you already have the keys, you should copy the private key file inside the container and rename it to **_oci_api_private.pem_**.

### **Step 3 - Upload the Public key**:
<br>Upload the Public key to **"APIkeys"** under user settings in OCI Console. Pre-requisite to use the complete functionality of the Automation Toolkit is to have the user as an administrator to the tenancy.
- Open the Console, and sign in as the user.
<br> View the details for the user who will be calling the API with the key pair.
- Open the Profile menu (User menu icon) and click User Settings.
- Click Add Public Key.</li><li>Paste the contents of the PEM public key in the dialog box and click Add.</li></ul>

### **Step 4 - Edit tenancyconfig.properties**:
<br>Enter the details to **tenancyconfig.properties** file.
```
[Default]
# Mandatory Fields
# Friendly name for the Customer Tenancy eg: demotenancy;
# The generated .auto.tfvars will be prefixed with this customer name
customer_name=
tenancy_ocid=
fingerprint=
user_ocid=
# Path of API Private Key (PEM Key) File; If the PEM keys were generated by running createAPI.py, leave this field empty.
# Defaults to /cd3user/tenancies/keys/oci_api_private.pem when left empty.
key_path=
# Region ; defaults to us-ashburn-1 when left empty.
region=

# Optional Fields
# SSH Key to launched instances
ssh_public_key=
```
### **Step 5 - Initialise the environment**:
<br>Initialise your environment to use the Automation Toolkit.
<br>```python createTenancyConfig.py tenancyconfig.properties```

**Note** - If the API Keys were generated and added to the OCI console using previous steps, it might take a couple of seconds to reflect. Thus, running the above command immediately might result in Authentication Errors.<br>In such cases, please retry after a minute.
<br>

→ Example execution of the script:
<br><img src = "https://user-images.githubusercontent.com/103508105/214566973-ba3446a7-c460-4028-8c45-c7b4e73d3b3c.png" width=70% height=70%>

## Appendix
→ Files created on successful execution of above steps - Description of the Generated files:

| Files Generated | At File Path | Comment/Purpose |
| --------------- | ------------ | --------------- |
| Config File | ```/cd3user/tenancies/<customer_name>/<customer_name>_config``` | Customer specific Config file is required for OCI API calls. |
| setUpOCI.properties | ```/cd3user/tenancies/<customer_name>/<customer_name>_setUpOCI.properties``` | Customer Specific properties files will be created. |
| Region based directories | ```/rcd3user/tenancies/<customer_name>/terraform_files``` | Tenancy's subscribed regions based directories for the generation and segregation of terraform files. |
| Variables File,Provider File, Root and Sub modules | ```/cd3user/tenancies/<customer_name>/terraform_files/<region>``` | Required for terraform to work. |
| Public and Private Key Pair | Copied from ```/cd3user/tenancies/keys/```<br>to<br>```/cd3user/tenancies/<customer_name>/``` | API Keys that were previously generated are moved to customer specific out directory locations for easy access. |
| A log file with the commands to execute | ```/cd3user/tenancies/<customer_name>/cmds.log``` | This file contains a copy of the Commands to execute section of the console output. |
| Documentation folder | ```/cd3user/tenancies/<customer_name>/documentation/user_guide/```<br>```/cd3user/tenancies/<customer_name>/documentation/terraform/``` | These folders contain the .md files with instructions on how to use the toolkit and edit the .auto.tfvars. |


<br><br>
<div align='center'>

| <a href="/cd3_automation_toolkit/documentation/user_guide/Launch_Docker_container.md">:arrow_backward: Prev</a> | <a href="/cd3_automation_toolkit/documentation/user_guide/Essentials_of_Automation_Toolkit.md">Next :arrow_forward:</a> |
| :---- | -------: |
  
</div>
